stages:
    - deploy

deploy_backend:
    stage: deploy
    image: alpine:latest
    script:
        - apk add --no-cache openssh-client docker-compose
        - echo "$SSH_PRIVATE_KEY" | base64 -d > deploy_key.pem
        - chmod 600 deploy_key.pem
        - export SSH_OPTIONS="-i deploy_key.pem -o StrictHostKeyChecking=no"
        - mkdir -p ~/.ssh && chmod 700 ~/.ssh
        - ssh-keyscan $SSH_SERVER_IP >> ~/.ssh/known_hosts && chmod 644 ~/.ssh/known_hosts

        - echo "Deploying backend to server..."
        - ssh $SSH_OPTIONS ${SSH_USER}@${SSH_SERVER_IP} "mkdir -p ~/taskmanager-prod"
        - scp $SSH_OPTIONS ./docker-compose.deploy.yml ${SSH_USER}@${SSH_SERVER_IP}:~/taskmanager-prod/docker-compose.yml

        - |
            ssh $SSH_OPTIONS ${SSH_USER}@${SSH_SERVER_IP} "
              cd ~/taskmanager-prod &&
              
              echo 'Logging into GitLab Registry...' &&
              # --- THE FIX IS HERE ---
              # Use our new, powerful deploy token credentials
              docker login -u ${REGISTRY_USER} -p ${REGISTRY_PASSWORD} ${CI_REGISTRY} &&

              echo 'Setting up production .env file...' &&
              # ... (echo commands are the same) ...
              echo 'NODE_ENV=production' >> .env &&

              echo 'Pulling the latest application image...' &&
              docker compose pull app &&

              echo 'Running database migrations...' &&
              docker compose run --rm app npx prisma migrate deploy &&

              echo 'Starting services...' &&
              docker compose up -d --force-recreate
            "
    rules:
        - if: $CI_COMMIT_BRANCH == 'main'
