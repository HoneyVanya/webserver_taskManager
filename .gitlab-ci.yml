image: docker:latest

stages:
    - build
    - test
    - push
    - deploy

services:
    - docker:dind

variables:
    APP_IMAGE: $CI_REGISTRY_IMAGE/$CI_COMMIT_REF_SLUG:$CI_COMMIT_SHA

build_app:
    stage: build
    script:
        - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
        - docker build -t $APP_IMAGE .
        - docker push $APP_IMAGE

run_tests:
    stage: test
    script:
        - 'echo "CRITICAL: No automated tests found. This is a placeholder stage."'
        - 'echo "Assuming the build was successful and proceeding."'

tag_latest:
    stage: push
    script:
        - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
        - docker pull $APP_IMAGE
        - docker tag $APP_IMAGE $CI_REGISTRY_IMAGE/latest
        - docker push $CI_REGISTRY_IMAGE/latest
    rules:
        - if: '$CI_COMMIT_BRANCH == "main"'

deploy_to_server:
    stage: deploy
    image: alpine:latest

    before_script:
        - 'apk update && apk add openssh-client'
        - 'eval $(ssh-agent -s)'
        - 'ssh-add "$SSH_PRIVATE_KEY_FILE"'
        - 'mkdir -p ~/.ssh'
        - 'chmod 700 ~/.ssh'
        - 'ssh-keyscan 3.75.211.159 >> ~/.ssh/known_hosts'
        - 'chmod 644 ~/.ssh/known_hosts'

    script:
        - |
            ssh ubuntu@3.75.211.159 << 'EOF'
              echo "--- Logging into production server ---"
              cd ~/webservertaskManager
              echo "--- Pulling latest code from main branch ---"
              git pull
              echo "--- Building and restarting application stack ---"
              docker compose up --build -d
              echo "--- Applying database migrations ---"
              docker compose exec app npx prisma migrate deploy
              echo "--- DEPLOYMENT COMPLETE ---"
            EOF

    rules:
        - if: '$CI_COMMIT_BRANCH == "main"'
