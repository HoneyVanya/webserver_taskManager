stages:
    - build
    - deploy

build_backend:
    stage: build
    image: docker:20.10.16
    services:
        - docker:20.10.16-dind
    variables:
        DOCKER_HOST: tcp://docker:2375
    before_script:
        - echo $REGISTRY_PASSWORD | docker login -u $REGISTRY_USER --password-stdin $CI_REGISTRY
    script:
        - echo "Building and pushing backend image..."
        - docker build -t ${CI_REGISTRY_IMAGE}:latest .
        - docker push ${CI_REGISTRY_IMAGE}:latest
    artifacts:
        paths:
            - docker-compose.prod.yml
            - nginx/

deploy_to_ec2:
    stage: deploy
    image: alpine:latest
    needs:
        - job: build_backend
          artifacts: true
        - project: taskmanager-group/taskmanager_frontend
          ref: main
          job: build_app
          artifacts: true
    script:
        - apk add --no-cache openssh-client docker-compose
        - echo "$SSH_PRIVATE_KEY" | base64 -d > deploy_key.pem
        - chmod 600 deploy_key.pem
        - export SSH_OPTIONS="-i deploy_key.pem -o StrictHostKeyChecking=no"
        - mkdir -p ~/.ssh && chmod 700 ~/.ssh
        - ssh-keyscan $SSH_SERVER_IP >> ~/.ssh/known_hosts && chmod 644 ~/.ssh/known_hosts

        - echo "Deploying full stack to production server..."
        - ssh $SSH_OPTIONS ${SSH_USER}@${SSH_SERVER_IP} "rm -rf ~/taskmanager-prod && mkdir -p ~/taskmanager-prod/nginx && mkdir -p ~/taskmanager-prod/frontend-dist"

        - mv dist frontend-dist

        - scp $SSH_OPTIONS ./docker-compose.prod.yml ${SSH_USER}@${SSH_SERVER_IP}:~/taskmanager-prod/docker-compose.yml
        - scp -r $SSH_OPTIONS ./nginx/* ${SSH_USER}@${SSH_SERVER_IP}:~/taskmanager-prod/nginx/
        - scp -r $SSH_OPTIONS ./frontend-dist/* ${SSH_USER}@${SSH_SERVER_IP}:~/taskmanager-prod/frontend-dist/

        - |
            ssh $SSH_OPTIONS ${SSH_USER}@${SSH_SERVER_IP} "
              cd ~/taskmanager-prod &&
              docker login -u ${REGISTRY_USER} -p ${REGISTRY_PASSWORD} ${CI_REGISTRY} &&
              
              echo 'DATABASE_URL=postgresql://myuser:mypassword@db:5432/taskmanager' > .env &&
              # ... all other .env variables ...
              echo 'NODE_ENV=production' >> .env &&

              docker compose pull app &&
              docker compose run --rm app npx prisma migrate deploy &&
              docker compose up -d --force-recreate
            "
    rules:
        - if: $CI_COMMIT_BRANCH == 'main'
