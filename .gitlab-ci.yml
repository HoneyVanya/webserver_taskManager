stages:
    - build
    - deploy

build_artifacts:
    stage: build
    image: docker:20.10.16
    services:
        - docker:20.10.16-dind
    before_script:
        - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
    script:
        - docker build -t $CI_REGISTRY_IMAGE:latest .
        - docker push $CI_REGISTRY_IMAGE:latest

        - echo "Cloning and building frontend..."
        - apk add --no-cache git curl xz
        - curl -L "https://nodejs.org/dist/v22.18.6/node-v22.18.6-linux-x64.tar.xz" -o node.tar.xz
        - tar -xf node.tar.xz
        - export PATH=$PWD/node-v22.18.6-linux-x64/bin:$PATH
        - node -v
        - npm -v
        - git clone ${FRONTEND_GIT_URL} ../frontend
        - cd ../frontend && npm ci && npm run build
        - mv dist ../webserver_taskmanager/frontend-dist
    artifacts:
        paths:
            - docker-compose.yml
            - nginx/
            - frontend-dist/

deploy_to_ec2:
    stage: deploy
    image: alpine:latest
    script:
        - apk add --no-cache openssh-client docker-compose
        - echo "$SSH_PRIVATE_KEY" | base64 -d > deploy_key.pem
        - chmod 600 deploy_key.pem
        - export SSH_OPTIONS="-i deploy_key.pem -o StrictHostKeyChecking=no"
        - mkdir -p ~/.ssh && chmod 700 ~/.ssh
        - ssh-keyscan $SSH_SERVER_IP >> ~/.ssh/known_hosts && chmod 644 ~/.ssh/known_hosts

        - echo "Deploying configuration files..."
        - ssh $SSH_OPTIONS ${SSH_USER}@${SSH_SERVER_IP} "mkdir -p ~/taskmanager-prod"
        # Copy only the necessary files, NO node_modules!
        - scp -r $SSH_OPTIONS ./docker-compose.yml ./nginx ./frontend-dist ${SSH_USER}@${SSH_SERVER_IP}:~/taskmanager-prod/

        - |
            ssh $SSH_OPTIONS ${SSH_USER}@${SSH_SERVER_IP} "
              cd ~/taskmanager-prod &&
              
              echo 'Logging into GitLab Registry...' &&
              docker login -u ${CI_REGISTRY_USER} -p ${CI_REGISTRY_PASSWORD} ${CI_REGISTRY} &&

              echo 'Setting up production .env file...' &&
              # ... (all your echo commands are the same) ...
              echo 'NODE_ENV=production' >> .env &&

              echo 'Pulling the latest application image...' &&
              docker-compose pull app &&

              echo 'Running database migrations...' &&
              docker-compose run --rm app npx prisma migrate deploy &&

              echo 'Restarting services...' &&
              docker-compose up -d --force-recreate
            "
