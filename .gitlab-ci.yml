image: docker:latest

stages:
    - build
    - test
    - deploy

services:
    - name: docker:dind
      alias: docker

variables:
    APP_IMAGE: $CI_REGISTRY_IMAGE/app:$CI_COMMIT_SHA
    DEPLOY_IMAGE: $CI_REGISTRY_IMAGE/deploy:latest

build_app:
    stage: build
    script:
        - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
        - docker build -t $APP_IMAGE .
        - docker push $APP_IMAGE

build_deploy_image:
    stage: build
    script:
        - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
        - docker build -t $DEPLOY_IMAGE -f deploy/Dockerfile .
        - docker push $DEPLOY_IMAGE

run_tests:
    stage: test
    script:
        - 'echo "CRITICAL: No automated tests found. This is a placeholder stage."'

deploy_to_server:
    stage: deploy
    image: $DEPLOY_IMAGE

    before_script:
        - 'eval $(ssh-agent -s)'
        - 'echo "$SSH_PRIVATE_KEY_FILE" | base64 -d | ssh-add -'
        - 'mkdir -p ~/.ssh && chmod 700 ~/.ssh'
        - 'ssh-keyscan 3.75.211.159 >> ~/.ssh/known_hosts'
        - 'chmod 644 ~/.ssh/known_hosts'

    script:
        - |
            ssh ubuntu@3.75.211.159 "
              echo '--- Logging into production server ---'
              cd ~/webservertaskManager

              echo '--- Setting the new image variable ---'
              export APP_IMAGE=${APP_IMAGE}
              
              echo '--- Pulling the new application image from GitLab Registry: ${APP_IMAGE} ---'
              docker compose pull app

              echo '--- Bringing down the old stack and starting the new one ---'
              docker compose up -d
              
              echo '--- Applying any new database migrations ---'
              # We add a small sleep to ensure the app container is ready.
              sleep 5 
              docker compose exec app npx prisma migrate deploy
              
              echo '--- DEPLOYMENT COMPLETE ---'
            "

    rules:
        - if: '$CI_COMMIT_BRANCH == "main"'
