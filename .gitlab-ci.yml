stages:
    - build
    - test
    - deploy

variables:
    DEPLOY_IMAGE: $CI_REGISTRY_IMAGE/deploy:latest

build:
    stage: build
    image: docker:latest
    services:
        - name: docker:dind
          alias: docker
    script:
        - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
        - docker build -t $DEPLOY_IMAGE -f deploy/Dockerfile .
        - docker push $DEPLOY_IMAGE

test:
    stage: test
    script:
        - echo "CRITICAL No automated tests. This is a placeholder."

deploy:
    stage: deploy
    image: $DEPLOY_IMAGE

    before_script:
        - 'eval $(ssh-agent -s)'
        - 'echo "$SSH_PRIVATE_KEY_FILE" | base64 -d | ssh-add -'
        - 'mkdir -p ~/.ssh && chmod 700 ~/.ssh'
        - 'ssh-keyscan 3.75.211.159 >> ~/.ssh/known_hosts'
        - 'chmod 644 ~/.ssh/known_hosts'

    script:
        - |
            ssh ubuntu@3.75.211.159 << 'EOF'
              echo "--- Logging into production server ---"
              cd ~/webservertaskManager
              
              echo "--- Pulling latest orchestration and source files ---"
              git pull
              
              echo "--- Building and deploying application with latest code ---"
              # This is now the single source of truth for the deployment.
              docker compose up --build -d --force-recreate
              
              echo "--- Applying any new database migrations ---"
              sleep 10
              docker compose exec app npx prisma migrate deploy
              
              echo "--- DEPLOYMENT COMPLETE ---"
            EOF

    rules:
        - if: '$CI_COMMIT_BRANCH == "main"'
