stages:
    - build
    - deploy

build_artifacts:
    stage: build
    image: node:22
    script:
        # --- Backend Build ---
        - echo "Building backend..."
        - npm ci
        - npm run build

        # --- Frontend Build ---
        - echo "Cloning frontend repository..."
        - git clone ${FRONTEND_GIT_URL} ../frontend
        - cd ../frontend
        - echo "Building frontend..."
        - npm ci
        - npm run build
        - mv dist ../webserver_taskmanager/frontend-dist
    artifacts:
        paths:
            # Backend files
            - dist/
            - node_modules/
            - package.json
            - package-lock.json
            - prisma/
            - docker-compose.yml
            - nginx/
            # Frontend files
            - frontend-dist/
        expire_in: 1 hour

deploy_to_ec2:
    stage: deploy
    image: alpine:latest
    before_script:
        - 'which ssh-agent || ( apk update && apk add openssh-client )'
        - eval $(ssh-agent -s)
        - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
        - mkdir -p ~/.ssh && chmod 700 ~/.ssh
        - ssh-keyscan $SSH_SERVER_IP >> ~/.ssh/known_hosts && chmod 644 ~/.ssh/known_hosts
    script:
        - echo "Deploying artifacts to production server..."
        - ssh ${SSH_USER}@${SSH_SERVER_IP} "mkdir -p ~/taskmanager-prod"
        - scp -r ./dist ./prisma ./node_modules ./package.json ./docker-compose.yml ./nginx ./frontend-dist ${SSH_USER}@${SSH_SERVER_IP}:~/taskmanager-prod/

        - |
            ssh ${SSH_USER}@${SSH_SERVER_IP} "
              cd ~/taskmanager-prod &&

              echo 'Setting up production .env file...' &&
              echo 'DATABASE_URL=${DATABASE_URL}' > .env &&
              echo 'PORT=${PORT}' >> .env &&
              echo 'JWT_ACCESS_SECRET=${JWT_ACCESS_SECRET}' >> .env &&
              echo 'JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}' >> .env &&
              echo 'JWT_ACCESS_EXPIRATION=${JWT_ACCESS_EXPIRATION}' >> .env &&
              echo 'JWT_REFRESH_EXPIRATION=${JWT_REFRESH_EXPIRATION}' >> .env &&
              echo 'GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}' >> .env &&
              echo 'GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}' >> .env &&
              echo 'RECAPTCHA_SECRET_KEY=${RECAPTCHA_SECRET_KEY}' >> .env &&
              echo 'GOOGLE_CALLBACK_URL=${GOOGLE_CALLBACK_URL}' >> .env &&
              echo 'FRONTEND_URL=${FRONTEND_URL}' >> .env &&
              echo 'NODE_ENV=production' >> .env &&

              echo 'Running database migrations...' &&
              docker-compose run --rm app npx prisma migrate deploy &&

              echo 'Restarting services with Docker Compose...' &&
              docker-compose up -d --build --force-recreate
            "
    rules:
        - if: $CI_COMMIT_BRANCH == 'main'
