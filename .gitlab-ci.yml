image: docker:latest

stages:
    - build
    - test
    - deploy

services:
    - name: docker:dind
      alias: docker

variables:
    APP_IMAGE: $CI_REGISTRY_IMAGE/app:$CI_COMMIT_SHA
    DEPLOY_IMAGE: $CI_REGISTRY_IMAGE/deploy:latest

build:
    stage: build
    script:
        - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
        - docker build -t $APP_IMAGE .
        - docker push $APP_IMAGE
        - docker build -t $DEPLOY_IMAGE -f deploy/Dockerfile .
        - docker push $DEPLOY_IMAGE

test:
    stage: test
    script:
        - 'echo "CRITICAL: No automated tests found. Placeholder."'

deploy:
    stage: deploy
    image: $DEPLOY_IMAGE

before_script:
    - 'eval $(ssh-agent -s)'
    - 'echo "$SSH_PRIVATE_KEY_FILE" | base64 -d | ssh-add -'
    - 'mkdir -p ~/.ssh && chmod 700 ~/.ssh'
    - 'ssh-keyscan 3.75.211.159 >> ~/.ssh/known_hosts'
    - 'chmod 644 ~/.ssh/known_hosts'

tag_latest:
    stage: push
    script:
        - |
            ssh ubuntu@3.75.211.159 "APP_IMAGE=$APP_IMAGE docker compose up -d"
    rules:
        - if: '$CI_COMMIT_BRANCH == "main"'
