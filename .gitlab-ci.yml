deploy:
    stage: deploy
    image: alpine:latest
    needs:
        - build
    before_script:
        - apk add --no-cache openssh-client rsync sed
        - echo "$SSH_PRIVATE_KEY" | base64 -d > deploy_key.pem
        - chmod 600 deploy_key.pem
        - mkdir -p ~/.ssh && chmod 700 ~/.ssh
        - ssh-keyscan $SSH_SERVER_IP >> ~/.ssh/known_hosts
    script:
        - echo "Preparing docker-compose file for deployment..."
        - sed -i "s|__IMAGE_TAG__|${CI_COMMIT_SHORT_SHA}|g" docker-compose.prod.yml

        - echo "Deploying services to server..."
        - export SSH_OPTIONS="-i deploy_key.pem -o StrictHostKeyChecking=no"

        - rsync -e "ssh $SSH_OPTIONS" docker-compose.prod.yml ${SSH_USER}@${SSH_SERVER_IP}:~/taskmanager-prod/docker-compose.yml

        - |
            ssh $SSH_OPTIONS ${SSH_USER}@${SSH_SERVER_IP} "
              set -e
              cd ~/taskmanager-prod
              
              echo '==> Creating .env file on server...'
              echo 'DATABASE_URL=postgresql://myuser:mypassword@db:5432/taskmanager' > .env
              echo 'PORT=3000' >> .env
              echo 'JWT_ACCESS_SECRET=${JWT_ACCESS_SECRET}' >> .env
              echo 'JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}' >> .env
              echo 'JWT_ACCESS_EXPIRATION=${JWT_ACCESS_EXPIRATION}' >> .env
              echo 'JWT_REFRESH_EXPIRATION=${JWT_REFRESH_EXPIRATION}' >> .env
              echo 'GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}' >> .env
              echo 'GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}' >> .env
              echo 'RECAPTCHA_SECRET_KEY=${RECAPTCHA_SECRET_KEY}' >> .env
              echo 'GOOGLE_CALLBACK_URL=${GOOGLE_CALLBACK_URL}' >> .env
              echo 'FRONTEND_URL=${FRONTEND_URL}' >> .env
              echo 'NODE_ENV=production' >> .env
              
              echo '==> Logging into GitLab Registry...'
              docker login -u ${REGISTRY_USER} -p ${REGISTRY_PASSWORD} ${CI_REGISTRY}
              
              echo '==> Pulling the latest tagged images...'
              docker compose pull
              
              echo '==> Running database migrations...'
              docker compose run --rm app npx prisma migrate deploy
              
              echo '==> Restarting services...'
              docker compose up -d --force-recreate
              
              echo '==> Cleaning up old images...'
              docker system prune -af

              echo '==> Deployment successful!'
            "
    rules:
        - if: $CI_COMMIT_BRANCH == 'main'
