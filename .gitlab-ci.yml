stages:
    - deploy

deploy_to_prod:
    stage: deploy
    image: alpine:latest

    before_script:
        - apk add --no-cache openssh-client git
        - eval $(ssh-agent -s)
        - echo "$SSH_PRIVATE_KEY_FILE" | base64 -d | ssh-add -

    script:
        - |
            # Using a double-quoted "EOF" to allow variable expansion for $GIT_PULL_URL
            ssh -o "StrictHostKeyChecking=no" -o "UserKnownHostsFile=/dev/null" ubuntu@3.75.211.159 << "EOF"
              # Fail the script immediately if any command fails
              set -e
              
              echo "--- [DEPLOY] Preparing server environment ---"
              # Check for the correct directory name: webservertaskmanager
              if [ ! -d "webservertaskmanager" ]; then
                echo "Cloning repository..."
                # Clone into the correct directory name: webservertaskmanager
                git clone "${GIT_PULL_URL}" webservertaskmanager
              fi
              
              # Change into the correct directory name: webservertaskmanager
              cd webservertaskmanager
              
              echo "--- [DEPLOY] Pulling latest code and configuration ---"
              # Ensure the remote URL is correct before pulling
              git remote set-url origin "${GIT_PULL_URL}"
              git pull
              
              echo "--- [DEPLOY] Building and restarting application stack ---"
              docker compose up --build -d --force-recreate
              
              echo "--- [DEPLOY] Waiting for application to become healthy ---"
              # Inspect the container with the correct name: webservertaskmanager-app-1
              until [ "$(docker inspect -f {{.State.Health.Status}} webservertaskmanager-app-1)" = "healthy" ]; do
                  echo "Waiting for app container to be healthy...";
                  sleep 2;
              done
              
              echo "--- [DEPLOY] Application is healthy. Applying database migrations. ---"
              docker compose exec app npx prisma migrate deploy
              
              echo "--- [DEPLOY] DEPLOYMENT COMPLETE ---"
            "EOF"

    rules:
        - if: '$CI_COMMIT_BRANCH == "main"'
